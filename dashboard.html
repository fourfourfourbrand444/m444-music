<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Releases | 444Music Distribution</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="form.css">

</head>
<body>
<header>My Releases | 444Music Distribution</header>
<main>
<input type="text" id="searchBar" placeholder="Search by Title, Artist, Genre, or Status...">
<div id="submissionsContainer"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzUD7avh7vJfeSMRl2o9F09_qd-pl0dSg",
  authDomain: "usersubmissionsportal.firebaseapp.com",
  projectId: "usersubmissionsportal",
  storageBucket: "usersubmissionsportal.firebasestorage.app",
  messagingSenderId: "734783502459",
  appId: "1:734783502459:web:cfa2cc5de6976003b24ade",
  measurementId: "G-WCRN117P8P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const container = document.getElementById("submissionsContainer");
const searchInput = document.getElementById("searchBar");

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="login.html"; return; }

  try{
    const q = query(collection(db,"submissions"), where("userId","==",user.uid));
    const snapshot = await getDocs(q);
    let submissions = [];
    snapshot.forEach(docSnap => { submissions.push({id:docSnap.id, ...docSnap.data()}); });
    displaySubmissions(submissions);

    searchInput.addEventListener("input", ()=>{
      const term = searchInput.value.toLowerCase();
      const filtered = submissions.filter(s =>
        s.title.toLowerCase().includes(term) ||
        s.artist.toLowerCase().includes(term) ||
        (s.genre && s.genre.toLowerCase().includes(term)) ||
        (s.status && s.status.toLowerCase().includes(term))
      );
      displaySubmissions(filtered);
    });

  } catch(err){ console.error(err); container.innerHTML="<p>Failed to load releases.</p>"; }
});

function displaySubmissions(subs){
  container.innerHTML = "";
  subs.forEach(sub=>{
    const card = document.createElement("div");
    card.className="card";

    const statusClass = sub.status || "Pending";

    let tracksHTML = "";
    if(sub.tracks && sub.tracks.length){
      tracksHTML = `<div class="tracks"><strong>Tracklist:</strong>`;
      sub.tracks.forEach((t,i)=>{
        tracksHTML += `<div>${i+1}. ${t.title} - ${t.artist} | <a href="${t.fileURL}" target="_blank" class="downloadLink">Download</a></div>`;
      });
      tracksHTML += `</div>`;
    }

    card.innerHTML = `
      <img class="cover" src="${sub.coverURL}" alt="Cover Art">
      <div class="info">
        <div><strong>Title:</strong> ${sub.title}</div>
        <div><strong>Artist:</strong> ${sub.artist}</div>
        <div><strong>Type:</strong> ${sub.releaseType}</div>
        <div><strong>Release Date:</strong> ${sub.releaseDate}</div>
        <div><strong>Featuring:</strong> ${sub.featuring || "-"}</div>
        <div><strong>Genre:</strong> ${sub.genre}</div>
        <div><strong>Language:</strong> ${sub.language}</div>
        <div><strong>Explicit:</strong> ${sub.explicit ? "Yes":"No"}</div>
        <div class="status ${statusClass}">${statusClass}</div>
        ${tracksHTML}
      </div>
    `;
    container.appendChild(card);
  });
}
</script>
</body>
</html>
